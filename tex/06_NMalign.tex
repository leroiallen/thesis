\begin{Verbatim}[commandchars=\\\{\},codes={\catcode`\$=3\catcode`\^=7\catcode`\_=8},gobble=0,numbers=left,fontfamily=fvm,fontshape=n,fontsize=\footnotesize,tabsize=2]
\PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
\PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{} Function \PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
\PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
\PY{c+c1}{\PYZsh{} }
\PY{c+c1}{\PYZsh{} Wmatrix(): Create a peak similarity matrix between an N\PYZhy{} and M\PYZhy{}alignment}
\PY{c+c1}{\PYZsh{} }
\PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
\PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{} Input \PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
\PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
\PY{c+c1}{\PYZsh{}}
\PY{c+c1}{\PYZsh{} Nmatchedpeaks: K x N matrix of matched pairs of the N alignment}
\PY{c+c1}{\PYZsh{} Npeaklists: a list object containing N matricies of  }
\PY{c+c1}{\PYZsh{}         (time,intensityVector) pairs: ($n_a$ x ($n_{Comp}$+1) matrix, a=1,...,N)}
\PY{c+c1}{\PYZsh{} Mmatchedpeaks: L x M matrix of matched pairs of the M alignment}
\PY{c+c1}{\PYZsh{} Mpeaklists: a list object containing M matricies of  }
\PY{c+c1}{\PYZsh{}         (time,intensityVector) pairs: ($n_b$ x ($n_{Comp}$+1) matrix, b=1,...,M)}
\PY{c+c1}{\PYZsh{}}
\PY{c+c1}{\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}\PYZsh{}}
\PY{c+c1}{\PYZsh{} }
\PY{c+c1}{\PYZsh{} e.g. Nmatchedpeaks =}
\PY{c+c1}{\PYZsh{} [ 1 0 1 0 ]}
\PY{c+c1}{\PYZsh{} [ 0 1 2 1 ]}
\PY{c+c1}{\PYZsh{} [ 0 0 0 2 ]}
\PY{c+c1}{\PYZsh{} [ 2 2 0 0 ]}
\PY{c+c1}{\PYZsh{} [ 3 3 3 3 ]}
\PY{c+c1}{\PYZsh{} [ 0 4 0 4 ]}
\PY{c+c1}{\PYZsh{} [ . . . . ]}
\PY{c+c1}{\PYZsh{} [ . . . . ]}
\PY{c+c1}{\PYZsh{} [ . . . . ]}
\PY{c+c1}{\PYZsh{} }
\PY{c+c1}{\PYZsh{} here K x N (N=4) matrix}
\PY{c+c1}{\PYZsh{} }
\PY{c+c1}{\PYZsh{} Npeaklist=}
\PY{c+c1}{\PYZsh{} [[1]]}
\PY{c+c1}{\PYZsh{} [$t_{1,1}$ $t_{1,2}$ ... $t_{1,n_1}$ ]}
\PY{c+c1}{\PYZsh{} [$x_{1,1}$ $x_{1,2}$ ... $x_{1,n_1}$ ]}
\PY{c+c1}{\PYZsh{} }
\PY{c+c1}{\PYZsh{} [[2]]}
\PY{c+c1}{\PYZsh{} [$t_{2,1}$ $t_{2,2}$ ... $t_{2,n_2}$ ]}
\PY{c+c1}{\PYZsh{} [$x_{2,1}$ $x_{2,2}$ ... $x_{2,n_2}$ ]}
\PY{c+c1}{\PYZsh{} }
\PY{c+c1}{\PYZsh{} ...}
\PY{c+c1}{\PYZsh{} }
\PY{c+c1}{\PYZsh{} [[N]]}
\PY{c+c1}{\PYZsh{} [$t_{N,1}$ $t_{N,2}$ ... $t_{N,n_N}$ ]}
\PY{c+c1}{\PYZsh{} [$x_{N,1}$ $x_{N,2}$ ... $x_{N,n_N}$ ]}
\PY{c+c1}{\PYZsh{} }
\PY{c+c1}{\PYZsh{} where $t_{i,j}$ is the time point j\PYZhy{}th peak for the i\PYZhy{}th spectrum}
\PY{c+c1}{\PYZsh{} where $x_{i,j}$ is the vector of intensities ($n_{Comp}$ long)  }
\PY{c+c1}{\PYZsh{}      i.e. $n_{Comp}$ x 1 matrix for the j\PYZhy{}th peak for the i\PYZhy{}th spectrum}
\PY{c+c1}{\PYZsh{} NB: each list item is a $(n_{Comp}+1)$ x $n_N$ matrix}
\PY{c+c1}{\PYZsh{}}
\PY{c+c1}{\PYZsh{} the \PYZus{}i\PYZus{} co\PYZhy{}ord is the row in the Nmatchedpeaks}
\PY{c+c1}{\PYZsh{} the \PYZus{}a\PYZus{} co\PYZhy{}ord is the column number of Nmatchedpeaks (the spectrum number)}
\PY{c+c1}{\PYZsh{} the \PYZus{}p\PYZus{} co\PYZhy{}ord is the peak number for the \PYZus{}a\PYZus{}th spectrum}
\PY{c+c1}{\PYZsh{}}
\PY{c+c1}{\PYZsh{} the \PYZus{}j\PYZus{},\PYZus{}b\PYZus{} and \PYZus{}q\PYZus{} co\PYZhy{}ords are defined similarly for the M\PYZhy{}alignment}

Wmatrix\PY{o}{\PYZlt{}\PYZhy{}}\PY{k+kr}{function}\PY{p}{(}Nmatchedpeaks\PY{p}{,}Npeaklists\PY{p}{,}Mmatchedpeaks\PY{p}{,}Mpeaklists
					\PY{p}{,}D\PY{p}{,}expon\PY{p}{,}lambda\PY{p}{)}\PY{p}{\PYZob{}}

   K\PY{o}{\PYZlt{}\PYZhy{}}\PY{k+kp}{nrow}\PY{p}{(}Nmatchedpeaks\PY{p}{)}
   N\PY{o}{\PYZlt{}\PYZhy{}}\PY{k+kp}{ncol}\PY{p}{(}Nmatchedpeaks\PY{p}{)}
   L\PY{o}{\PYZlt{}\PYZhy{}}\PY{k+kp}{nrow}\PY{p}{(}Mmatchedpeaks\PY{p}{)}
   M\PY{o}{\PYZlt{}\PYZhy{}}\PY{k+kp}{ncol}\PY{p}{(}Mmatchedpeaks\PY{p}{)}
   W\PY{o}{\PYZlt{}\PYZhy{}}\PY{k+kt}{matrix}\PY{p}{(}\PY{l+m}{0}\PY{p}{,}nrow\PY{o}{=}K\PY{p}{,}ncol\PY{o}{=}L\PY{p}{)}
   
   \PY{k+kr}{for}\PY{p}{(}i \PY{k+kr}{in} \PY{l+m}{1}\PY{o}{:}K\PY{p}{)}\PY{p}{\PYZob{}}
      \PY{k+kr}{for}\PY{p}{(}j \PY{k+kr}{in} \PY{l+m}{1}\PY{o}{:}L\PY{p}{)}\PY{p}{\PYZob{}}
         numerator\PY{o}{\PYZlt{}\PYZhy{}}\PY{l+m}{0}
         denominator\PY{o}{\PYZlt{}\PYZhy{}}\PY{l+m}{0}
         \PY{k+kr}{for}\PY{p}{(}a \PY{k+kr}{in} \PY{l+m}{1}\PY{o}{:}N\PY{p}{)}\PY{p}{\PYZob{}}
            p\PY{o}{\PYZlt{}\PYZhy{}}Nmatchedpeaks\PY{p}{[}i\PY{p}{,}a\PY{p}{]}
            \PY{k+kr}{if}\PY{p}{(}p\PY{o}{\PYZgt{}}\PY{l+m}{0}\PY{p}{)}\PY{p}{\PYZob{}}
               \PY{k+kr}{for}\PY{p}{(}b \PY{k+kr}{in} \PY{l+m}{1}\PY{o}{:}M\PY{p}{)}\PY{p}{\PYZob{}}
                  \PY{k+kp}{q}\PY{o}{\PYZlt{}\PYZhy{}}Mmatchedpeaks\PY{p}{[}j\PY{p}{,}b\PY{p}{]}
                  \PY{k+kr}{if}\PY{p}{(}\PY{k+kp}{q}\PY{o}{\PYZgt{}}\PY{l+m}{0}\PY{p}{)}\PY{p}{\PYZob{}}
                     t\PYZus{}a\PY{o}{\PYZlt{}\PYZhy{}}Npeaklists\PY{p}{[[}a\PY{p}{]]}\PY{p}{[}\PY{l+m}{1}\PY{p}{,}p\PY{p}{]}
                     p\PYZus{}a\PY{o}{\PYZlt{}\PYZhy{}}Npeaklists\PY{p}{[[}a\PY{p}{]]}\PY{p}{[}\PY{l+m}{\PYZhy{}1}\PY{p}{,}p\PY{p}{]}
                     t\PYZus{}b\PY{o}{\PYZlt{}\PYZhy{}}Mpeaklists\PY{p}{[[}b\PY{p}{]]}\PY{p}{[}\PY{l+m}{1}\PY{p}{,}\PY{k+kp}{q}\PY{p}{]}
                     p\PYZus{}b\PY{o}{\PYZlt{}\PYZhy{}}Mpeaklists\PY{p}{[[}b\PY{p}{]]}\PY{p}{[}\PY{l+m}{\PYZhy{}1}\PY{p}{,}\PY{k+kp}{q}\PY{p}{]}
                     numerator\PY{o}{\PYZlt{}\PYZhy{}}numerator\PY{o}{+}
                     	PeakSim\PY{p}{(}p\PYZus{}a\PY{p}{,}t\PYZus{}a\PY{p}{,}p\PYZus{}b\PY{p}{,}t\PYZus{}b\PY{p}{,}D\PY{p}{,}expon\PY{p}{,}lambda\PY{p}{)}
                     denominator\PY{o}{\PYZlt{}\PYZhy{}}denominator\PY{l+m}{+1}
                  \PY{p}{\PYZcb{}}
               \PY{p}{\PYZcb{}}
            \PY{p}{\PYZcb{}}
         \PY{p}{\PYZcb{}}
         \PY{k+kr}{if}\PY{p}{(}denominator\PY{o}{\PYZgt{}}\PY{l+m}{0}\PY{p}{)} W\PY{p}{[}i\PY{p}{,}j\PY{p}{]}\PY{o}{\PYZlt{}\PYZhy{}}numerator\PY{o}{/}denominator
         \PY{k+kr}{else} W\PY{p}{[}i\PY{p}{,}j\PY{p}{]}\PY{o}{\PYZlt{}\PYZhy{}}\PY{l+m}{0}
      \PY{p}{\PYZcb{}}
   \PY{p}{\PYZcb{}}
   \PY{k+kr}{return}\PY{p}{(}W\PY{p}{)}
\PY{p}{\PYZcb{}}
\end{Verbatim}
